var slice=[].slice,FONT="20pt 'Gloria Hallelujah'",ShakyCanvas=function(t){this.ctx=t.getContext("2d"),this.ctx.lineWidth=3,this.ctx.font=FONT,this.ctx.textBaseline="middle"};ShakyCanvas.prototype.moveTo=function(t,e){this.x0=t,this.y0=e},ShakyCanvas.prototype.lineTo=function(t,e){return this.shakyLine(this.x0,this.y0,t,e),this.moveTo(t,e)},ShakyCanvas.prototype.shakyLine=function(t,e,n,a){var r,i,o,s,h,c,l,u,y,x,v,d;return i=n-t,o=a-e,c=Math.sqrt(i*i+o*o),r=Math.sqrt(c)/1.5,s=Math.random(),h=Math.random(),l=Math.random()*r,u=Math.random()*r,y=t+i*s+o/c*l,v=e+o*s-i/c*l,x=t+i*h-o/c*u,d=e+o*h+i/c*u,this.ctx.moveTo(t,e),this.ctx.bezierCurveTo(y,v,x,d,n,a)},ShakyCanvas.prototype.bulb=function(t,e){var n,a,r,i;for(n=function(){return 2*Math.random()-1},i=[],a=r=0;2>=r;a=++r)this.beginPath(),this.ctx.arc(t+n(),e+n(),5,0,2*Math.PI,!0),this.ctx.closePath(),i.push(this.ctx.fill());return i},ShakyCanvas.prototype.arrowhead=function(t,e,n,a){var r,i,o,s,h,c,l,u,y,x,v;return s=t-n,h=e-a,r=0===h?0>s?-Math.PI:0:Math.atan(h/s),i=r+.5,o=r-.5,c=20,u=n+c*Math.cos(i),x=a+c*Math.sin(i),this.beginPath(),this.moveTo(u,x),this.lineTo(n,a),this.stroke(),l=20,y=n+l*Math.cos(o),v=a+l*Math.sin(o),this.beginPath(),this.moveTo(y,v),this.lineTo(n,a),this.stroke()},ShakyCanvas.prototype.beginPath=function(){return this.ctx.beginPath()},ShakyCanvas.prototype.stroke=function(){return this.ctx.stroke()},ShakyCanvas.prototype.setStrokeStyle=function(t){return this.ctx.strokeStyle=t},ShakyCanvas.prototype.setFillStyle=function(t){return this.ctx.fillStyle=t},ShakyCanvas.prototype.fillText=function(){var t,e;return t=1>arguments.length?[]:slice.call(arguments,0),(e=this.ctx).fillText.apply(e,t)};var CELL_SIZE=15,X=function(t){return t*CELL_SIZE+CELL_SIZE/2},Y=function(t){return t*CELL_SIZE+CELL_SIZE/2},Point=function(t,e){this.x=t,this.y=e},Line=function(t,e,n,a,r,i,o){this.x0=t,this.y0=e,this.start=n,this.x1=a,this.y1=r,this.end=i,this.color=o};Line.prototype.draw=function(t){return t.setStrokeStyle(this.color),t.setFillStyle(this.color),t.beginPath(),t.moveTo(X(this.x0),Y(this.y0)),t.lineTo(X(this.x1),Y(this.y1)),t.stroke(),this._ending(t,this.start,X(this.x1),Y(this.y1),X(this.x0),Y(this.y0)),this._ending(t,this.end,X(this.x0),Y(this.y0),X(this.x1),Y(this.y1))},Line.prototype._ending=function(t,e,n,a,r,i){switch(e){case"circle":return t.bulb(r,i);case"arrow":return t.arrowhead(n,a,r,i)}};var Text=function(t,e,n,a){this.x0=t,this.y0=e,this.text=n,this.color=a};Text.prototype.draw=function(t){return t.setFillStyle(this.color),t.fillText(this.text,X(this.x0),Y(this.y0))};var parseASCIIArt=function(t){var e,n,a,r,i,o,s,h,c,l,u,y,x,v,d,f,p,g,k,w,m,L,S;for(p=t.split("\n"),l=p.length,m=Math.max.apply(Math,function(){var t,e,n;for(n=[],t=0,e=p.length;e>t;t++)f=p[t],n.push(f.length);return n}()),n=[],e=function(t,e){var a;return null!=(a=n[t])?a[e]:void 0},S=x=0,d=p.length;d>x;S=++x)for(f=p[S],n[S]=f.split(""),L=v=g=f.length,k=m;g>k?v>k:k>v;L=g>k?--v:++v)n[S][L]=" ";for(y=function(t,n){var a;return a=e(n,t),"|"===a||"-"===a||"+"===a||"~"===a||"!"===a},w=function(t,n){switch(e(n,t)){case"~":case"!":return"#666"}},u=function(t,n){var a;return a=e(n,t),"*"===a||"<"===a||">"===a||"^"===a||"v"===a},c=function(){var t,e,a,r;for(S=t=0,a=l;0>a?t>a:a>t;S=0>a?--t:++t)for(L=e=0,r=m;0>r?e>r:r>e;L=0>r?--e:++e)if("|"===n[S][L]||"-"===n[S][L])return new Point(L,S)},a={"-":new Point(1,0),"|":new Point(0,1)},i=function(t,a,r,i){switch(e(a,t)){case"|":case"-":case"*":case">":case"<":case"^":case"v":case"~":case"!":return n[a][t]=" ";case"+":switch(r=1-r,i=1-i,n[a][t]=" ",e(a-i,t-r)){case"|":case"!":case"+":return void(n[a][t]="|");case"-":case"~":return void(n[a][t]="-")}switch(e(a+i,t+r)){case"|":case"!":case"+":return n[a][t]="|";case"-":case"~":return n[a][t]="-"}}},r=function(t){var e,n,a,r;if(e=t.x0!==t.x1?1:0,n=t.y0!==t.y1?1:0,0!==e||0!==n){for(L=t.x0+e,S=t.y0+n,a=t.x1-e,r=t.y1-n;a>=L&&r>=S;)i(L,S,e,n),L+=e,S+=n;return i(t.x0,t.y0,e,n),i(t.x1,t.y1,e,n)}return i(t.x0,t.y0,e,n)},h=[],o=function(){var t,e,i,o,s,l,x,v,d;if(t=c(),null==t)return!1;for(i=a[n[t.y][t.x]],l=t.x,v=t.y,e=null;y(l-i.x,v-i.y);)l-=i.x,v-=i.y,null==e&&(e=w(l,v));for(s=null,u(l-i.x,v-i.y)&&(l-=i.x,v-=i.y,s="*"===n[v][l]?"circle":"arrow"),x=t.x,d=t.y;y(x+i.x,d+i.y);)x+=i.x,d+=i.y,null==e&&(e=w(x,d));return o=null,u(x+i.x,d+i.y)&&(x+=i.x,d+=i.y,o="*"===n[d][x]?"circle":"arrow"),f=new Line(l,v,s,x,d,o,null!=e?e:"black"),h.push(f),r(f),"arrow"===s&&(f.x0-=i.x,f.y0-=i.y),"arrow"===o&&(f.x1+=i.x,f.y1+=i.y),!0},s=function(){var t,e,a,r,i,o,s,c;for(o=[],S=a=0,i=l;0>i?a>i:i>a;S=0>i?--a:++a)L=0,o.push(function(){var a;for(a=[];m>L;)if(" "===n[S][L])a.push(L++);else{for(s=e=L;m>e&&" "!==n[S][e];)e++;c=n[S].slice(s,e).join(""),r=h[h.length-1],"Text"===(null!=r?r.constructor.name:void 0)&&r.x0+r.text.length+1===s?r.text=r.text+" "+c:(t="black","\\"===c[0]&&"\\"===c[c.length-1]&&(c=c.substring(1,c.length-1),t="#666"),h.push(new Text(L,S,c,t))),a.push(L=e)}return a}());return o};o(););return s(),h},doc=document,$=function(t){return doc.getElementById(t)},drawDiagram=function(){console.log("Random debug message"),ga("send",{hitType:"event",eventCategory:"general",eventAction:"click",eventLabel:"redraw"});var t,e,n,a,r,i,o,s,h,c,l;for(a=parseASCIIArt($("textarea").value),l=0,r=0,i=0,s=a.length;s>i;i++)n=a[i],"Line"===n.constructor.name&&(l=Math.max(l,X(n.x1+1)),r=Math.max(r,Y(n.y1+1)));for(t=$("canvas"),t.width=l,t.height=r,e=new ShakyCanvas(t),c=[],o=0,h=a.length;h>o;o++)n=a[o],c.push(n.draw(e));return c},textarea=$("textarea");textarea.addEventListener("change",drawDiagram),textarea.addEventListener("keyup",drawDiagram),doc.addEventListener("DOMContentLoaded",drawDiagram,!1),doc.fonts.ready.then(drawDiagram),$("download").addEventListener("click",function(){ga("send",{hitType:"event",eventCategory:"general",eventAction:"click",eventLabel:"download"});var t=$("canvas").toDataURL("image/png");$("download").href=t},!1),$("close").addEventListener("click",function(){$("overlay").style.display="none"},!1),$("about").addEventListener("click",function(){ga("send",{hitType:"event",eventCategory:"general",eventAction:"click",eventLabel:"about"}),$("overlay").style.display="block"},!1);